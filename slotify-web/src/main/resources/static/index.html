<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Slotify - Find Your Meeting Slot</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #fafafa; }
        h1 { color: #1a1a1a; margin-bottom: 5px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card h2 { margin: 0 0 16px 0; font-size: 16px; color: #333; }
        label { display: block; margin: 8px 0; font-weight: 500; color: #444; }
        input[type="file"] { margin: 10px 0; }
        select, input[type="number"] { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        select { min-width: 150px; }
        input[type="number"] { width: 80px; }
        button { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; }
        button:hover { background: #1d4ed8; }
        .btn-secondary { background: #10b981; }
        .btn-secondary:hover { background: #059669; }
        .inline { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .participant-count { background: #e0f2fe; color: #0369a1; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }

        /* Participant selection */
        .participant-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px; }
        .participant-column h3 { font-size: 14px; margin: 0 0 10px 0; color: #374151; }
        .participant-column.required h3 { color: #dc2626; }
        .participant-column.optional h3 { color: #2563eb; }
        .participant-list { display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto; }
        .participant-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f9fafb; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
        .participant-item:hover { background: #f3f4f6; }
        .participant-item.required { background: #fef2f2; border-left: 3px solid #dc2626; }
        .participant-item.optional { background: #eff6ff; border-left: 3px solid #2563eb; }
        .participant-item input { margin: 0; }
        .participant-item span { font-size: 13px; }

        /* Results */
        #results { margin-top: 20px; }
        .slots-header { font-size: 14px; color: #666; margin-bottom: 12px; }
        .slot-card { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 12px 16px; margin: 8px 0; }
        .slot-time { font-size: 18px; font-weight: 600; color: #166534; }
        .slot-attendees { font-size: 12px; color: #666; margin-top: 4px; }
        .slot-attendees .available { color: #16a34a; }
        .slot-attendees .unavailable { color: #dc2626; }
        .no-slots { color: #dc2626; font-weight: 500; padding: 12px; background: #fef2f2; border-radius: 8px; }

        /* Timeline */
        .timeline { margin: 20px 0; }
        .timeline-header { display: flex; margin-left: 90px; font-size: 11px; color: #888; margin-bottom: 4px; }
        .timeline-header span { flex: 1; text-align: left; }
        .person-row { display: flex; align-items: center; margin: 6px 0; }
        .person-name { width: 90px; font-weight: 500; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #374151; }
        .person-name.required { color: #dc2626; }
        .person-name.optional { color: #2563eb; }
        .day-bar { flex: 1; height: 32px; background: linear-gradient(to right, #d1fae5, #a7f3d0); position: relative; border-radius: 6px; overflow: hidden; }
        .busy-block { position: absolute; top: 0; height: 100%; background: #f87171; border-radius: 2px; }
        .available-block { position: absolute; top: 0; height: 100%; background: #10b981; opacity: 0.85; border-radius: 2px; }
        .legend { display: flex; gap: 20px; font-size: 12px; color: #666; margin-top: 12px; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-box { width: 16px; height: 16px; border-radius: 4px; }
        .error { color: #dc2626; padding: 12px; background: #fef2f2; border-radius: 8px; }

        .form-row { display: flex; align-items: center; gap: 16px; margin-top: 16px; flex-wrap: wrap; }
        input[type="time"] { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .btn-small { background: #6b7280; padding: 8px 12px; font-size: 12px; }
        .btn-small:hover { background: #4b5563; }
        .blackout-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .blackout-chip { display: inline-flex; align-items: center; gap: 6px; background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 20px; font-size: 13px; }
        .blackout-chip button { background: none; border: none; color: #92400e; cursor: pointer; padding: 0; font-size: 16px; line-height: 1; }
        .blackout-chip button:hover { color: #dc2626; }
    </style>
</head>
<body>
    <h1>Slotify</h1>
    <p class="subtitle">Find the perfect meeting slot for everyone</p>

    <div class="card">
        <h2>1. Load Calendar</h2>
        <div class="inline">
            <input type="file" id="file" accept=".csv" aria-label="Select CSV calendar file">
            <button type="button" onclick="upload()">Upload CSV</button>
        </div>
    </div>

    <div id="timeline-card" class="card" style="display:none">
        <h2>Availability <span id="participant-count" class="participant-count"></span></h2>
        <div id="timeline"></div>
    </div>

    <div id="settings-card" class="card" style="display:none">
        <h2>2. Settings</h2>
        <div class="form-row">
            <div>
                <label for="buffer">Buffer between meetings</label>
                <input type="number" id="buffer" value="0" min="0" max="60" step="5" aria-label="Buffer time in minutes"> min
            </div>
            <div>
                <label for="blackout">Blocked time (e.g., lunch)</label>
                <div class="inline">
                    <input type="time" id="blackout-start" value="12:00" aria-label="Blackout start time">
                    <span>to</span>
                    <input type="time" id="blackout-end" value="13:00" aria-label="Blackout end time">
                    <button type="button" class="btn-small" onclick="addBlackout()">Add</button>
                </div>
            </div>
        </div>
        <div id="blackout-list" class="blackout-list"></div>
    </div>

    <div id="config" class="card" style="display:none">
        <h2>3. Meeting Request</h2>

        <div class="participant-grid">
            <div class="participant-column required">
                <h3>Required Participants</h3>
                <div id="required-list" class="participant-list"></div>
            </div>
            <div class="participant-column optional">
                <h3>Optional Participants</h3>
                <div id="optional-list" class="participant-list"></div>
            </div>
        </div>

        <div class="form-row">
            <div>
                <label for="duration">Duration</label>
                <select id="duration">
                    <option value="30">30 min</option>
                    <option value="60" selected>1 hour</option>
                    <option value="90">1.5 hours</option>
                    <option value="120">2 hours</option>
                </select>
            </div>
            <div style="margin-top: 24px;">
                <button type="button" class="btn-secondary" onclick="findSlots()">Find Available Slots</button>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let busySlots = {};
        let allParticipants = [];
        let blackouts = [];
        const START_HOUR = 7, END_HOUR = 19;

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function addBlackout() {
            const start = document.getElementById('blackout-start').value;
            const end = document.getElementById('blackout-end').value;
            if (!start || !end) return alert('Please select both start and end times');
            if (start >= end) return alert('End time must be after start time');

            // Check for duplicates
            if (blackouts.some(b => b.start === start && b.end === end)) {
                return alert('This blocked time already exists');
            }

            blackouts.push({ start, end });
            renderBlackouts();
        }

        function removeBlackout(index) {
            blackouts.splice(index, 1);
            renderBlackouts();
        }

        function renderBlackouts() {
            const list = document.getElementById('blackout-list');
            if (blackouts.length === 0) {
                list.innerHTML = '<span style="color:#888;font-size:13px">No blocked times configured</span>';
                return;
            }
            list.innerHTML = blackouts.map((b, i) => `
                <span class="blackout-chip">
                    ${escapeHtml(b.start)} - ${escapeHtml(b.end)}
                    <button type="button" onclick="removeBlackout(${i})" aria-label="Remove blocked time">&times;</button>
                </span>
            `).join('');
        }

        function renderParticipantLists() {
            const requiredList = document.getElementById('required-list');
            const optionalList = document.getElementById('optional-list');

            requiredList.innerHTML = allParticipants.map(p => `
                <label class="participant-item">
                    <input type="checkbox" name="required" value="${escapeHtml(p)}" data-participant="${escapeHtml(p)}" aria-label="Required: ${escapeHtml(p)}">
                    <span>${escapeHtml(p)}</span>
                </label>
            `).join('');

            optionalList.innerHTML = allParticipants.map(p => `
                <label class="participant-item">
                    <input type="checkbox" name="optional" value="${escapeHtml(p)}" data-participant="${escapeHtml(p)}" aria-label="Optional: ${escapeHtml(p)}">
                    <span>${escapeHtml(p)}</span>
                </label>
            `).join('');

            // Add event listeners for mutual exclusion
            requiredList.querySelectorAll('input').forEach(cb => {
                cb.addEventListener('change', () => toggleParticipant(cb.value, 'required'));
            });
            optionalList.querySelectorAll('input').forEach(cb => {
                cb.addEventListener('change', () => toggleParticipant(cb.value, 'optional'));
            });
        }

        function toggleParticipant(name, type) {
            const requiredCheckbox = document.querySelector(`#required-list input[data-participant="${CSS.escape(name)}"]`);
            const optionalCheckbox = document.querySelector(`#optional-list input[data-participant="${CSS.escape(name)}"]`);

            if (type === 'required' && requiredCheckbox.checked) {
                optionalCheckbox.checked = false;
                optionalCheckbox.parentElement.classList.remove('optional');
                requiredCheckbox.parentElement.classList.add('required');
            } else if (type === 'optional' && optionalCheckbox.checked) {
                requiredCheckbox.checked = false;
                requiredCheckbox.parentElement.classList.remove('required');
                optionalCheckbox.parentElement.classList.add('optional');
            } else {
                requiredCheckbox.parentElement.classList.remove('required');
                optionalCheckbox.parentElement.classList.remove('optional');
            }
            updateTimeline();
        }

        function updateTimeline() {
            const required = [...document.querySelectorAll('#required-list input:checked')].map(c => c.value);
            const optional = [...document.querySelectorAll('#optional-list input:checked')].map(c => c.value);
            renderTimeline(allParticipants, required, optional);
        }

        function renderTimeline(participants, required = [], optional = []) {
            const hours = Array.from({length: END_HOUR - START_HOUR + 1}, (_, i) => String(START_HOUR + i).padStart(2, '0'));
            let html = '<div class="timeline">';
            html += '<div class="timeline-header">' + hours.map(h => `<span>${h}</span>`).join('') + '</div>';

            participants.forEach(name => {
                const slots = busySlots[name] || [];
                const safeName = escapeHtml(name);
                const isRequired = required.includes(name);
                const isOptional = optional.includes(name);
                const nameClass = isRequired ? 'required' : (isOptional ? 'optional' : '');

                html += `<div class="person-row">
                    <div class="person-name ${nameClass}" title="${safeName}">${safeName}</div>
                    <div class="day-bar">`;
                slots.forEach(slot => {
                    const left = timeToPercent(slot.start);
                    const width = timeToPercent(slot.end) - left;
                    html += `<div class="busy-block" style="left:${left}%;width:${width}%"></div>`;
                });
                html += '</div></div>';
            });

            html += '</div>';
            html += '<div class="legend">';
            html += '<div class="legend-item"><div class="legend-box" style="background:linear-gradient(to right, #d1fae5, #a7f3d0)"></div>Free</div>';
            html += '<div class="legend-item"><div class="legend-box" style="background:#f87171"></div>Busy</div>';
            html += '<div class="legend-item"><div class="legend-box" style="background:#10b981"></div>Available</div>';
            html += '</div>';
            document.getElementById('timeline').innerHTML = html;
        }

        function timeToPercent(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            const totalMinutes = (h - START_HOUR) * 60 + m;
            const dayMinutes = (END_HOUR - START_HOUR) * 60;
            return Math.max(0, Math.min(100, (totalMinutes / dayMinutes) * 100));
        }

        function highlightSlots(slots) {
            document.querySelectorAll('.available-block').forEach(el => el.remove());
            slots.forEach(slot => {
                const startTime = slot.start;
                const endTime = slot.end;

                document.querySelectorAll('.day-bar').forEach(bar => {
                    const left = timeToPercent(startTime);
                    const width = timeToPercent(endTime) - left;
                    const block = document.createElement('div');
                    block.className = 'available-block';
                    block.style.cssText = `left:${left}%;width:${width}%`;
                    bar.appendChild(block);
                });
            });
        }

        async function upload() {
            const file = document.getElementById('file').files[0];
            if (!file) return alert('Select a file first');

            const form = new FormData();
            form.append('file', file);

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: form });
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();

                if (data.error) return alert(data.error);

                busySlots = data.busySlots;
                allParticipants = data.participants;
                document.getElementById('participant-count').textContent = `${allParticipants.length} participants`;
                document.getElementById('timeline-card').style.display = 'block';
                document.getElementById('settings-card').style.display = 'block';
                document.getElementById('config').style.display = 'block';
                document.getElementById('results').innerHTML = '';
                renderBlackouts();
                renderParticipantLists();
                renderTimeline(data.participants);
            } catch (e) {
                alert('Upload failed: ' + e.message);
            }
        }

        async function findSlots() {
            const required = [...document.querySelectorAll('#required-list input:checked')].map(c => c.value);
            const optional = [...document.querySelectorAll('#optional-list input:checked')].map(c => c.value);

            if (required.length === 0) {
                return alert('Select at least one required participant');
            }

            try {
                const res = await fetch('/api/meeting-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        required,
                        optional,
                        durationMinutes: +document.getElementById('duration').value,
                        bufferMinutes: +document.getElementById('buffer').value,
                        blackouts
                    })
                });
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();

                if (data.slots.length) {
                    let html = `<div class="slots-header">Found ${data.slots.length} available slot(s) for ${required.length} required participant(s):</div>`;
                    data.slots.forEach(slot => {
                        html += `<div class="slot-card">
                            <div class="slot-time">${escapeHtml(slot.start)}</div>
                            <div class="slot-attendees">`;
                        if (slot.availableOptional.length > 0) {
                            html += `<span class="available">✓ ${slot.availableOptional.map(escapeHtml).join(', ')}</span>`;
                        }
                        if (slot.unavailableOptional.length > 0) {
                            html += ` <span class="unavailable">✗ ${slot.unavailableOptional.map(escapeHtml).join(', ')}</span>`;
                        }
                        html += `</div></div>`;
                    });
                    document.getElementById('results').innerHTML = html;
                } else {
                    document.getElementById('results').innerHTML = '<p class="no-slots">No available slots found for all required participants</p>';
                }
                highlightSlots(data.slots);
            } catch (e) {
                document.getElementById('results').innerHTML = '<p class="error">Request failed: ' + escapeHtml(e.message) + '</p>';
            }
        }
    </script>
</body>
</html>
