<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Slotify - Find Your Meeting Slot</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background: #fafafa; }
        h1 { color: #1a1a1a; margin-bottom: 5px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card h2 { margin: 0 0 16px 0; font-size: 16px; color: #333; }
        label { display: block; margin: 8px 0; font-weight: 500; color: #444; }
        input[type="file"] { margin: 10px 0; }
        select, input[type="number"] { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        select { min-width: 150px; }
        input[type="number"] { width: 80px; }
        button { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; }
        button:hover { background: #1d4ed8; }
        .btn-secondary { background: #10b981; }
        .btn-secondary:hover { background: #059669; }
        .inline { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .participant-count { background: #e0f2fe; color: #0369a1; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }
        #results { margin-top: 20px; }
        .slots-header { font-size: 14px; color: #666; margin-bottom: 10px; }
        .slot { display: inline-block; background: #10b981; color: white; padding: 8px 16px; margin: 4px; border-radius: 6px; font-weight: 500; font-size: 14px; }
        .no-slots { color: #dc2626; font-weight: 500; }
        .timeline { margin: 20px 0; }
        .timeline-header { display: flex; margin-left: 90px; font-size: 11px; color: #888; margin-bottom: 4px; }
        .timeline-header span { flex: 1; text-align: left; }
        .person-row { display: flex; align-items: center; margin: 6px 0; }
        .person-name { width: 90px; font-weight: 500; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #374151; }
        .day-bar { flex: 1; height: 32px; background: linear-gradient(to right, #d1fae5, #a7f3d0); position: relative; border-radius: 6px; overflow: hidden; }
        .busy-block { position: absolute; top: 0; height: 100%; background: #f87171; border-radius: 2px; }
        .available-block { position: absolute; top: 0; height: 100%; background: #10b981; opacity: 0.85; border-radius: 2px; }
        .legend { display: flex; gap: 20px; font-size: 12px; color: #666; margin-top: 12px; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-box { width: 16px; height: 16px; border-radius: 4px; }
        .error { color: #dc2626; padding: 12px; background: #fef2f2; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>Slotify</h1>
    <p class="subtitle">Find the perfect meeting slot for everyone</p>

    <div class="card">
        <h2>1. Load Calendar</h2>
        <div class="inline">
            <input type="file" id="file" accept=".csv">
            <button type="button" onclick="upload()">Upload CSV</button>
        </div>
    </div>

    <div id="timeline-card" class="card" style="display:none">
        <h2>Availability <span id="participant-count" class="participant-count"></span></h2>
        <div id="timeline"></div>
    </div>

    <div id="config" class="card" style="display:none">
        <h2>2. Find Meeting Slot</h2>
        <div class="inline">
            <label for="duration">Duration</label>
            <select id="duration">
                <option value="30">30 min</option>
                <option value="60" selected>1 hour</option>
                <option value="90">1.5 hours</option>
                <option value="120">2 hours</option>
            </select>
            <label for="buffer">Buffer</label>
            <input type="number" id="buffer" value="0" min="0" step="5"> min
            <button type="button" class="btn-secondary" onclick="findSlots()">Find Slots</button>
        </div>
        <div id="results"></div>
    </div>

    <script>
        let busySlots = {};
        let allParticipants = [];
        const START_HOUR = 7, END_HOUR = 19;

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function renderTimeline(participants) {
            const hours = Array.from({length: END_HOUR - START_HOUR + 1}, (_, i) => String(START_HOUR + i).padStart(2, '0'));
            let html = '<div class="timeline">';
            html += '<div class="timeline-header">' + hours.map(h => `<span>${h}</span>`).join('') + '</div>';

            participants.forEach(name => {
                const slots = busySlots[name] || [];
                const safeName = escapeHtml(name);
                html += `<div class="person-row">
                    <div class="person-name" title="${safeName}">${safeName}</div>
                    <div class="day-bar">`;
                slots.forEach(slot => {
                    const left = timeToPercent(slot.start);
                    const width = timeToPercent(slot.end) - left;
                    html += `<div class="busy-block" style="left:${left}%;width:${width}%"></div>`;
                });
                html += '</div></div>';
            });

            html += '</div>';
            html += '<div class="legend">';
            html += '<div class="legend-item"><div class="legend-box" style="background:linear-gradient(to right, #d1fae5, #a7f3d0)"></div>Free</div>';
            html += '<div class="legend-item"><div class="legend-box" style="background:#f87171"></div>Busy</div>';
            html += '<div class="legend-item"><div class="legend-box" style="background:#10b981"></div>Available</div>';
            html += '</div>';
            document.getElementById('timeline').innerHTML = html;
        }

        function timeToPercent(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            const totalMinutes = (h - START_HOUR) * 60 + m;
            const dayMinutes = (END_HOUR - START_HOUR) * 60;
            return Math.max(0, Math.min(100, (totalMinutes / dayMinutes) * 100));
        }

        function highlightSlots(slots) {
            document.querySelectorAll('.available-block').forEach(el => el.remove());
            slots.forEach(startTime => {
                const duration = +document.getElementById('duration').value;
                const [h, m] = startTime.split(':').map(Number);
                const endH = h + Math.floor((m + duration) / 60);
                const endM = (m + duration) % 60;
                const endTime = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;

                document.querySelectorAll('.day-bar').forEach(bar => {
                    const left = timeToPercent(startTime);
                    const width = timeToPercent(endTime) - left;
                    const block = document.createElement('div');
                    block.className = 'available-block';
                    block.style.cssText = `left:${left}%;width:${width}%`;
                    bar.appendChild(block);
                });
            });
        }

        async function upload() {
            const file = document.getElementById('file').files[0];
            if (!file) return alert('Select a file first');

            const form = new FormData();
            form.append('file', file);

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: form });
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();

                if (data.error) return alert(data.error);

                busySlots = data.busySlots;
                allParticipants = data.participants;
                document.getElementById('participant-count').textContent = `${allParticipants.length} participants`;
                document.getElementById('timeline-card').style.display = 'block';
                document.getElementById('config').style.display = 'block';
                document.getElementById('results').innerHTML = '';
                renderTimeline(data.participants);
            } catch (e) {
                alert('Upload failed: ' + e.message);
            }
        }

        async function findSlots() {
            try {
                const res = await fetch('/api/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        participants: allParticipants,
                        durationMinutes: +document.getElementById('duration').value,
                        bufferMinutes: +document.getElementById('buffer').value
                    })
                });
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();

                if (data.slots.length) {
                    document.getElementById('results').innerHTML =
                        '<div class="slots-header">Available times for all ' + allParticipants.length + ' participants:</div>' +
                        data.slots.map(s => `<span class="slot">${s}</span>`).join('');
                } else {
                    document.getElementById('results').innerHTML = '<p class="no-slots">No available slots found for all participants</p>';
                }
                highlightSlots(data.slots);
            } catch (e) {
                document.getElementById('results').innerHTML = '<p class="error">Request failed: ' + escapeHtml(e.message) + '</p>';
            }
        }
    </script>
</body>
</html>
