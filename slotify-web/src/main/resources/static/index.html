<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Slotify - Find Your Meeting Slot</title>
    <style>
        body { font-family: system-ui; max-width: 600px; margin: 40px auto; padding: 0 20px; }
        h1 { color: #333; }
        .section { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; }
        label { display: block; margin: 8px 0; }
        input[type="file"], select, input[type="number"] { margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        #participants { display: flex; flex-wrap: wrap; gap: 10px; }
        #results { margin-top: 20px; }
        .slot { display: inline-block; background: #28a745; color: white; padding: 5px 10px; margin: 3px; border-radius: 4px; }
        .error { color: red; }
        .timeline { margin: 20px 0; }
        .timeline-header { display: flex; margin-left: 80px; font-size: 11px; color: #888; }
        .timeline-header span { flex: 1; text-align: left; }
        .person-row { display: flex; align-items: center; margin: 4px 0; }
        .person-name { width: 80px; font-weight: 500; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .day-bar { flex: 1; height: 28px; background: #e8f5e9; position: relative; border-radius: 4px; overflow: hidden; }
        .busy-block { position: absolute; top: 0; height: 100%; background: #ef5350; }
        .available-block { position: absolute; top: 0; height: 100%; background: #4caf50; opacity: 0.7; }
        .legend { font-size: 12px; color: #666; margin-top: 10px; }
        .legend span { margin-right: 15px; }
        .legend-box { display: inline-block; width: 14px; height: 14px; vertical-align: middle; margin-right: 4px; border-radius: 2px; }
    </style>
</head>
<body>
    <h1>Slotify</h1>
    <p>Find the perfect meeting slot for everyone</p>

    <div class="section">
        <h3><label for="file">1. Upload Calendar CSV</label></h3>
        <input type="file" id="file" accept=".csv">
        <button type="button" onclick="upload()">Upload</button>
    </div>

    <div class="section" id="config" style="display:none">
        <h3>2. Select Participants</h3>
        <div id="participants"></div>

        <h3><label for="duration">3. Meeting Duration</label></h3>
        <select id="duration">
            <option value="30">30 minutes</option>
            <option value="60" selected>60 minutes</option>
            <option value="90">90 minutes</option>
            <option value="120">2 hours</option>
        </select>

        <h3><label for="buffer">4. Buffer Between Meetings</label></h3>
        <input type="number" id="buffer" value="0" min="0" step="5"> minutes

        <br><br>
        <button type="button" onclick="findSlots()">Find Available Slots</button>
    </div>

    <div id="timeline"></div>

    <div id="results"></div>

    <script>
        let busySlots = {};
        const START_HOUR = 7, END_HOUR = 19;

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function renderTimeline(participants) {
            const hours = Array.from({length: END_HOUR - START_HOUR + 1}, (_, i) => String(START_HOUR + i).padStart(2, '0'));
            let html = '<div class="timeline">';
            html += '<div class="timeline-header">' + hours.map(h => `<span>${h}</span>`).join('') + '</div>';

            participants.forEach(name => {
                const slots = busySlots[name] || [];
                const safeName = escapeHtml(name);
                html += `<div class="person-row">
                    <div class="person-name" title="${safeName}">${safeName}</div>
                    <div class="day-bar">`;
                slots.forEach(slot => {
                    const left = timeToPercent(slot.start);
                    const width = timeToPercent(slot.end) - left;
                    html += `<div class="busy-block" style="left:${left}%;width:${width}%"></div>`;
                });
                html += '</div></div>';
            });

            html += '<div class="legend"><span><span class="legend-box" style="background:#e8f5e9"></span>Free</span>';
            html += '<span><span class="legend-box" style="background:#ef5350"></span>Busy</span>';
            html += '<span><span class="legend-box" style="background:#4caf50"></span>Available</span></div></div>';
            document.getElementById('timeline').innerHTML = html;
        }

        function timeToPercent(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            const totalMinutes = (h - START_HOUR) * 60 + m;
            const dayMinutes = (END_HOUR - START_HOUR) * 60;
            return Math.max(0, Math.min(100, (totalMinutes / dayMinutes) * 100));
        }

        function highlightSlots(slots) {
            document.querySelectorAll('.available-block').forEach(el => el.remove());
            slots.forEach(startTime => {
                const duration = +document.getElementById('duration').value;
                const [h, m] = startTime.split(':').map(Number);
                const endH = h + Math.floor((m + duration) / 60);
                const endM = (m + duration) % 60;
                const endTime = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;

                document.querySelectorAll('.day-bar').forEach(bar => {
                    const left = timeToPercent(startTime);
                    const width = timeToPercent(endTime) - left;
                    const block = document.createElement('div');
                    block.className = 'available-block';
                    block.style.cssText = `left:${left}%;width:${width}%`;
                    bar.appendChild(block);
                });
            });
        }

        async function upload() {
            const file = document.getElementById('file').files[0];
            if (!file) return alert('Select a file first');

            const form = new FormData();
            form.append('file', file);

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: form });
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();

                if (data.error) return alert(data.error);

                busySlots = data.busySlots;
                document.getElementById('participants').innerHTML = data.participants
                    .map(p => `<label><input type="checkbox" value="${escapeHtml(p)}" checked> ${escapeHtml(p)}</label>`)
                    .join('');
                document.getElementById('config').style.display = 'block';
                document.getElementById('results').innerHTML = '';
                renderTimeline(data.participants);
            } catch (e) {
                alert('Upload failed: ' + e.message);
            }
        }

        async function findSlots() {
            const participants = [...document.querySelectorAll('#participants input:checked')].map(c => c.value);
            if (!participants.length) return alert('Select at least one participant');

            try {
                const res = await fetch('/api/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        participants,
                        durationMinutes: +document.getElementById('duration').value,
                        bufferMinutes: +document.getElementById('buffer').value
                    })
                });
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();

                document.getElementById('results').innerHTML = data.slots.length
                    ? '<h3>Available Slots</h3>' + data.slots.map(s => `<span class="slot">${s}</span>`).join('')
                    : '<p class="error">No available slots found</p>';
                highlightSlots(data.slots);
            } catch (e) {
                document.getElementById('results').innerHTML = '<p class="error">Request failed: ' + escapeHtml(e.message) + '</p>';
            }
        }
    </script>
</body>
</html>
